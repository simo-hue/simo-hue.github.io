{{/*
Parameters:
- Src: String (required) - Path to image or URL
- Context: Page (required) - The current page context
- Alt: String (optional) - Alt text
- Title: String (optional) - Title attribute (and caption for lightbox)
- Class: String (optional) - CSS classes
- Lightbox: Boolean (optional) - Enable lightbox wrapper (default false)
- Resize: String (optional) - Resize command (e.g. "800x") if specific size needed
*/}}

{{ $src := .Src }}
{{ $context := .Context }}
{{ $alt := .Alt | default "" }}
{{ $title := .Title | default "" }}
{{ $class := .Class | default "" }}
{{ $lightbox := .Lightbox | default false }}

{{/* Find the image resource */}}
{{ $image := "" }}
{{ if (urls.Parse $src).Scheme }}
{{/* External URL, can't process */}}
{{ else }}
{{/* Try Page Resource */}}
{{ $image = $context.Resources.GetMatch $src }}
{{ if not $image }}
{{/* Try Global Resource */}}
{{ $image = resources.Get $src }}
{{ end }}
{{ end }}

{{ if $image }}
{{/* Lightbox Wrapper */}}
{{ if $lightbox }}
<a href="{{ $image.RelPermalink }}" class="glightbox block" data-type="image" data-desc-position="bottom"
    data-title="{{ $title }}" data-description="{{ $alt }}">
    {{ end }}

    {{/* Process Image - Generate WebP and Responsive Sizes */}}
    {{/* Only resize if image is large enough, otherwise use original */}}
    {{ $width := $image.Width }}

    {{ if gt $width 1200 }}
    {{ $small := $image.Resize "480x webp" }}
    {{ $medium := $image.Resize "800x webp" }}
    {{ $large := $image.Resize "1200x webp" }}
    {{ $fallback := $image.Resize "1200x jpg" }}

    <img loading="lazy" src="{{ $fallback.RelPermalink }}" srcset="
          {{ $small.RelPermalink }} 480w,
          {{ $medium.RelPermalink }} 800w,
          {{ $large.RelPermalink }} 1200w" sizes="(max-width: 480px) 480px, (max-width: 800px) 800px, 1200px"
        alt="{{ $alt }}" title="{{ $title }}" class="{{ $class }}" width="{{ $fallback.Width }}"
        height="{{ $fallback.Height }}">
    {{ else }}
    {{/* Image is small, just convert to WebP/Resize to original width if needed */}}
    {{ $converted := $image.Resize (printf "%dx webp" $width) }}
    <img loading="lazy" src="{{ $image.RelPermalink }}" srcset="{{ $converted.RelPermalink }} {{ $width }}w"
        sizes="100vw" alt="{{ $alt }}" title="{{ $title }}" class="{{ $class }}" width="{{ $width }}"
        height="{{ $image.Height }}">
    {{ end }}

    {{ if $lightbox }}
</a>
{{ end }}

{{ else }}
{{/* Fallback for external or missing images */}}
{{ if $lightbox }}
<a href="{{ $src }}" class="glightbox block" data-type="image" data-title="{{ $title }}" data-description="{{ $alt }}">
    {{ end }}
    <img loading="lazy" src="{{ $src }}" alt="{{ $alt }}" title="{{ $title }}" class="{{ $class }}">
    {{ if $lightbox }}
</a>
{{ end }}
{{ end }}