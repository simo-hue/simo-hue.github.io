name: Hugo Translation & Deploy

on:
  # Trigger automatico su push al branch principale
  push:
    branches: [ master, main ]
    paths:
      - 'content/english/**'
      - 'scripts/**'
      - '.github/workflows/**'

  # Trigger manuale
  workflow_dispatch:

  # Schedule giornaliero alle 2:00 AM
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  translate:
    name: 🌐 Auto-translate content
    runs-on: ubuntu-24.04

    steps:
      - name: 📋 Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 🐍 Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: 📦 Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🔍 Check for content changes
        id: check_changes
        run: |
          # Verifica se ci sono file da tradurre modificati di recente
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep "content/english" || echo "")
          if [[ -n "$CHANGED_FILES" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "translate=true" >> $GITHUB_OUTPUT
            echo "🔄 Translation needed"
          else
            echo "translate=false" >> $GITHUB_OUTPUT
            echo "⏭️ No translation needed"
          fi

      - name: 🌐 Run translation script
        if: steps.check_changes.outputs.translate == 'true'
        run: |
          echo "🚀 Starting automatic translation..."
          python scripts/translate_markdown.py
          echo "✅ Translation completed"

      - name: 📊 Generate translation report
        if: steps.check_changes.outputs.translate == 'true'
        run: |
          echo "## 🌐 Translation Report" >> $GITHUB_STEP_SUMMARY
          echo "| Language | Files | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY

          for lang_dir in content/*/; do
            if [[ "$lang_dir" != "content/english/" ]]; then
              lang_name=$(basename "$lang_dir")
              file_count=$(find "$lang_dir" -name "*.md" 2>/dev/null | wc -l)
              echo "| $lang_name | $file_count | ✅ Updated |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: 📝 Commit translated files
        if: steps.check_changes.outputs.translate == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Aggiungi tutti i file tradotti
          git add content/italian/ content/french/ content/spanish/ || true

          # Committa solo se ci sono cambiamenti
          if git diff --cached --quiet; then
            echo "⏭️ No changes to commit"
          else
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S UTC')
            git commit -m "🤖 Auto-translate content - $TIMESTAMP

            - Translated content from English to Italian, French, Spanish
            - Generated by GitHub Actions workflow
            - Timestamp: $TIMESTAMP"

            echo "✅ Changes committed"
          fi

      - name: 🚀 Push changes
        if: steps.check_changes.outputs.translate == 'true'
        run: |
          if git log origin/master..HEAD --oneline | grep -q "Auto-translate"; then
            git push origin master
            echo "✅ Changes pushed to repository"
          else
            echo "⏭️ No new commits to push"
          fi

  deploy:
    name: 🚀 Deploy to GitHub Pages
    runs-on: ubuntu-24.04
    needs: translate
    if: always()

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: 📋 Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: 🏗️ Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: 🗂️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install npm dependencies
        run: npm ci

      - name: 🏗️ Build Hugo site
        run: |
          echo "🏗️ Building Hugo site..."
          hugo --minify --environment production
          echo "✅ Site built successfully"

      - name: 📄 Setup Pages
        uses: actions/configure-pages@v4

      - name: 📤 Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    name: 📬 Notify completion
    runs-on: ubuntu-24.04
    needs: [translate, deploy]
    if: always()

    steps:
      - name: 📊 Report results
        run: |
          echo "## 🎉 Workflow Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Translation Job:** ${{ needs.translate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy Job:** ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site URL:** https://simo-hue.github.io" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY